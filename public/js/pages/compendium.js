"use strict";let defaultFilters={chapter:"items",sorting:"name",ordering:"asc",active:[]};caas.compendium={filters:Object.assign({},defaultFilters),results:null,pause:!1,init:function(){this.setup(),this.events()},setup:function(){this.restoreFilters()},events:function(){$("#chapter-select .dropdown-item").on("click",this.chapterSelect),$("a.page-link").on("click",this.paginate),$("input[name=name]").on("keyup keypress focus blur change",this.searchWidth).on("keyup keypress change blur",$.debounce(250,!1,caas.compendium.search)),$("#name-filter .dropdown-item").on("click",this.sorting),$("#select-filters .dropdown-item").on("click",this.createFilter),$("body").on("click",this.closeFilter).on("click",".filter",this.activateFilter).on("click",".filter .delete",this.destroyFilter),$(".large-view").on("click",this.switchView)},chapterSelect:function(e){void 0!==e&&e.preventDefault();var t=$(this),i=t.data("chapter");t.siblings().removeClass("active"),t.addClass("active"),$("#chapter").html(t.text()),$("#filters [data-chapter]").each(function(){var e=$(this),t=e.data("chapter");e.toggleAttr("hidden",-1===t.indexOf(i))}),caas.compendium.filters.chapter=i,$("#results").attr("data-chapter",i),caas.compendium.getResults()},switchView:function(e){void 0!==e&&e.preventDefault();var t=$("#results").hasClass("-large-view");$("#results").toggleClass("-large-view",!t),$(".large-view .-disable").toggleAttr("hidden",t),$(".large-view .-enable").toggleAttr("hidden",!t)},activateFilter:function(e){var t=$(this);t.hasClass("-active")||(void 0!==e&&e.preventDefault(),$("#filtration .filter").removeClass("-active"),t.addClass("-active"),0==t.find("input:focus").length&&t.find("input:visible").first().focus())},closeFilter:function(e){if(void 0!==e&&($(e.target).closest(".filter").length>0||0==$("#filtration .filter.-active").length))return;var t=$("#filtration .filter.-active").first(),i=t.data("filter"),a=t.data("type");if(t.removeClass(t.hasClass("-keep")?"-keep":"-active"),"enabled"==a)caas.compendium.filters[i]="true";else if("single"==a)caas.compendium.filters[i]=t.find('input[name="'+i+'"]').val();else if("range"==a){var s=t.data("keys");caas.compendium.filters[s[0]]=t.find('input[name="'+s[0]+'"]').val(),caas.compendium.filters[s[1]]=t.find('input[name="'+s[1]+'"]').val()}else{var l=t.find("input").attr("name").replace(/\[\]$/,""),n=[];t.find("input:checked").each(function(){n.push($(this).val())}),caas.compendium.filters[l]=n.join(",");var r=t.find(".values");if(""==caas.compendium.filters[l].length)r.find("img, i, .multiple").toggleAttr("hidden",!0),r.find(".waiting-icon").toggleAttr("hidden",!1);else{var c=t.find("input:checked").length>1,o=t.find("input:checked").first().next("label").children().first();r.find("img, i").toggleAttr("hidden",!1),o.is("i")?r.find("i").first().attr("class",o.attr("class")):o.is("img")&&r.find("img").first().attr("src",o.attr("src")),r.find(".multiple").toggleAttr("hidden",!c),r.find(".waiting-icon").toggleAttr("hidden",!0)}}caas.compendium.getResults()},destroyFilter:function(e){var t=$(this).closest(".filter"),i=t.data("filter"),a=t.data("type");if(t.is(".-active")||caas.compendium.pause){if("enabled"==a||"single"==a)delete caas.compendium.filters[i];else if("range"==a){var s=t.data("keys");delete caas.compendium.filters[s[0]],delete caas.compendium.filters[s[1]]}else{var l=t.find("input").attr("name").replace(/\[\]$/,"");delete caas.compendium.filters[l]}var n=caas.compendium.filters.active.indexOf(i);n>-1&&caas.compendium.filters.active.splice(n),t.remove(),$('#select-filters .dropdown-item[data-filter="'+i+'"]').removeClass("disabled"),caas.compendium.getResults()}},createFilter:function(e){void 0!==e&&e.preventDefault();var t=$(this);if(!t.hasClass("disabled")){var i=t.data("filter");if("clear"==i)return caas.compendium.clearFilters();var a=t.data("type"),s=t.data("text")||t.text(),l=t.find("i").attr("class"),n=$("#filters .filter.-"+a).clone();if(t.addClass("disabled"),n.find(".filter-icon").addClass(l),n.find(".filter-label").html(s),n.data("filter",i).data("type",a),"enabled"==a)n.find("input").attr("name",i);else if("single"==a){var r=n.find("input");r.attr("name",i).attr("min",t.data("min")).attr("max",t.data("max"));var c=t.data("list");if(void 0!==c){var o=$('<datalist id="'+i+'List"></datalist>');r.attr("list",i+"List"),$.each(c.split(","),function(){o.append($('<option value="'+this+'"></option>'))}),o.insertAfter(r)}}else if("range"==a){var d=n.find("input"),m=t.data("keys").split(",");n.data("keys",m),d.first().attr("name",m[0]),d.last().attr("name",m[1]),d.attr("min",t.data("min")).attr("max",t.data("max"))}$("#filtration").append(n),caas.compendium.filters.active.push(i),caas.pause||(caas.tooltip.init(),caas.compendium.activateFilter.call(n),n.addClass("-keep"),"enabled"==a&&(caas.compendium.getResults(),setTimeout(function(){n.removeClass("-active")},500)))}},clearFilters:function(){this.pause=!0,$("#name-filter input").val(""),this.sorting.call($("#name-filter .dropdown-item").first()),$("#filtration .filter .delete").each(function(){caas.compendium.destroyFilter.call($(this))}),this.pause=!1,$("#pre-results").toggleAttr("hidden",!1),$("#no-results").toggleAttr("hidden",!0),$("#results .compendium-item:not(.-template)").remove(),this.filters=Object.assign({},defaultFilters),caas.storage.remove(game.slug+"-compendium-filters"),caas.storage.remove(game.slug+"-compendium-results"),$("#name-filter input").focus()},searchWidth:function(){var e=$(this);e.css("width",7*(e.val().length+2)+24+"px")},search:function(e){var t=(caas.compendium.filters.name||"")+"";caas.compendium.filters.name=$(this).val(),t!=caas.compendium.filters.name&&caas.compendium.getResults()},getResults:function(e){if(!caas.compendium.pause){void 0!==this.jqXHR&&this.jqXHR.abort(),void 0===e&&(e=1),this.filters.page=e,this.toggleLoader(!0);var t=Object.assign({},this.filters);delete t.chapter,delete t.active,this.jqXHR=$.ajax({method:"GET",url:"/api/"+this.filters.chapter,data:t,dataType:"json"}).done(this.buildResults).always(function(){caas.compendium.toggleLoader(!1)})}},toggleLoader:function(e){$("#select-filters > button > i").toggleClass("fa-filter",!e).toggleClass("fa-cog fa-spin",e)},buildResults:function(e){caas.compendium.pause||(caas.storage.set(game.slug+"-compendium-filters",JSON.stringify(caas.compendium.filters)),caas.storage.set(game.slug+"-compendium-results",JSON.stringify(e)));caas.compendium.filters;if($("#pre-results").toggleAttr("hidden",!0),$("#no-results").toggleAttr("hidden",0!=e.data.length),0!=e.data.length){var t=$("#results"),i=t.find(".-template");t.find(".compendium-item:not(.-template)").remove(),$.each(e.data,function(e,t){var a=i.clone(!0);a=caas.compendium.buildRow(a,t),caas.lists.updateButtons(),a.removeClass("-template"),a.toggleAttr("hidden",!1),a.insertBefore(i)}),caas.tooltip.init(),caas.compendium.buildNavigation(e)}},buildNavigation:function(e){$("#pageNumber").html(e.meta.current_page),["prev","next"].forEach(function(t){var i=$(".page-link.-"+t),a=e.links[t],s=null!==a;s?(i.toggleAttr("tabindex",!1),a=a.replace(/^.*page=/,"")):i.attr("tabindex","-1"),i.data("page",a).closest(".page-item").toggleClass("disabled",!s)})},paginate:function(e){e.preventDefault();var t=$(this);t.closest(".page-item").hasClass("disabled")||caas.compendium.getResults(t.data("page"))},buildRow:function(e,t){if(e.find("> img").attr("src","/assets/"+game.slug+"/item/"+t.icon+".png"),e.find(".name").addClass("rarity-"+t.rarity).html(t.name),e.find(".ilvl").html(t.ilvl),e.find(".category").html(t.category),void 0!==t.recipes){var i=t.recipes[0];if(e.find(".recipes .level").html(i.level),null!==i.sublevel&&i.sublevel>0)for(var a=0;a<i.sublevel;a++)e.find(".recipes .level").append('<span class="sublevel-icon"></span>');e.find(".recipes .job img").first().attr("src","/assets/"+game.slug+"/jobs/crafting-"+i.job.icon+".png"),2==t.recipes.length?(e.find(".recipes .job img").last().attr("src","/assets/"+game.slug+"/jobs/crafting-"+t.recipes[1].job.icon+".png"),e.find(".recipes .multiple").remove()):t.recipes.length>2?(e.find(".recipes .job img").last().remove(),e.find(".recipes .multiple").html("✚").attr("data-toggle","tooltip").attr("title",i.job.icon+" + "+(t.recipes.length-1)+" others")):(e.find(".recipes .multiple").remove(),e.find(".recipes .job img").last().remove())}else e.find(".recipes").remove();return void 0!==t.equipment?(e.find(".equipment .level").html(t.equipment.level),e.find(".equipment .job img").first().attr("src","/assets/"+game.slug+"/jobs/"+t.equipment.jobs[0].icon+".png"),2==t.equipment.jobs.length?(e.find(".equipment .job img").last().attr("src","/assets/"+game.slug+"/jobs/"+t.equipment.jobs[1].icon+".png"),e.find(".equipment .multiple").remove()):t.equipment.jobs.length>2?(e.find(".equipment .job img").last().remove(),e.find(".equipment .multiple").html("✚").attr("data-toggle","tooltip").attr("title",t.equipment.jobs[0].icon+" + "+(t.equipment.jobs.length-1)+" others")):(e.find(".equipment .multiple").remove(),e.find(".equipment .job img").last().remove())):e.find(".equipment").remove(),e.find(".add-to-list").data("id",t.id),e},restoreFilters:function(){this.pause=!0;var e=JSON.parse(caas.storage.get(game.slug+"-compendium-filters"))||Object.assign({},this.filters),t=JSON.parse(caas.storage.get(game.slug+"-compendium-results"));if(null!=t&&void 0!==t.data&&this.buildResults(t),this.chapterSelect.call($('#chapter-select [data-chapter="'+e.chapter+'"]')),$("#filtration input[name=name]").val(e.name),this.searchWidth.call($("input[name=name]")),this.sorting.call($('#name-filter .dropdown-item[data-sorting="'+e.sorting+'"][data-ordering="'+e.ordering+'"]')),e.active.length>0)for(var i=0;i<e.active.length;i++){var a=e.active[i],s=$('#select-filters .dropdown-item[data-filter="'+a+'"]'),l=s.data("filter"),n=s.data("type");this.createFilter.call(s);var r=$("#filtration .filter").last();if("enabled"==n);else if("single"==n)void 0!==e[l]&&r.find("input").val(e[l]);else if("range"==n)r.find("input").each(function(){var t=$(this);t.val(e[t.attr("name")])});else if(void 0!==e[l])for(var c=e[l].split(","),o=0;o<c.length;o++)r.find('input[name="'+l+'[]"][value="'+c[o]+'"]').prop("checked",!0);this.closeFilter(),r.removeClass("-active")}$("#name-filter input").focus(),this.filters=e,caas.tooltip.init(),this.pause=!1},sorting:function(e){void 0!==e&&e.preventDefault();var t=$(this);t.siblings(".dropdown-item").removeClass("active"),t.addClass("active"),$("#name-filter .dropdown-toggle").html(t.html()),caas.compendium.filters.sorting=t.data("sorting"),caas.compendium.filters.ordering=t.data("ordering"),caas.compendium.getResults()},toggleFilter:function(){$("html").toggleClass("filter-open")}},$(function(){caas.core.initializePage("compendium")});